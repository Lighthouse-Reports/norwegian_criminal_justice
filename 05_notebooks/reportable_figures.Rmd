---
title: "reportable_figures"
author: "Justin Braun"
date: "2024-11-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

## Set up & and prep data

```{r load packages}
#load packages
require(ggplot2)
require(dplyr)
require(tidyr)
require(readxl)
require(openxlsx)
require(broom)
require(stringr)
library(sjPlot)
library(sjmisc)
library(purrr)
library(lmtest)
library(sandwich)
library(estimatr)
library(stats)
library(tibble)
library(ggthemes)
library(stargazer)
library(patchwork)
```

```{r load data}
#load short data frame: case level
df_short <- readxl::read_excel('../01_preprocessed_data/hidden/full_short.xlsx') %>%
  mutate(punishment_prison_days_conditiional = as.numeric(punishment_prison_days_conditiional),
         case_district_court = relevel(factor(case_district_court), "Oslo tingrett")) #reorder factor for regr. analysis
```

```{r prep config}
### FUNCTION: extract_vars ###
# @param cur_fp: filepath to spreadsheet containing variable list
# @param cur_sheet: sheet name containing variable list
#
# returns: vector of variables
extract_vars <- function(cur_fp, cur_sheet){
  cur_df <- readxl::read_excel(cur_fp, sheet = cur_sheet)
  return(cur_df$vars)
}

fp_desc <- '../02_config/config_descriptives.xlsx' #file path for descriptive variables
fp_regr <- '../02_config/config_regression.xlsx' #file path for regression variables

#load variables into vectors
defendant_chars_descriptive <- extract_vars(fp_desc, 'defendant_chars')
judge_chars_descriptive <- extract_vars(fp_desc,'judge_chars')
outcomes_descriptive <- extract_vars(fp_desc, 'outcomes')

defendant_chars_regression <- extract_vars(fp_regr, 'defendant_chars')
judge_chars_regression <- extract_vars(fp_regr,'judge_chars')
outcomes_regression <- extract_vars(fp_regr, 'outcomes')


circs_regression <- openxlsx::read.xlsx('../02_config/aggravating_mitigating_circs.xlsx')$col
sections_regression <- openxlsx::read.xlsx('../02_config/sections.xlsx')$col
sections_descriptive <- sections_regression

#set up output folder
output_fp <- '../03_results/reportable_figures/'
dir.create(output_fp, showWarnings = F)

output_fp_full_results <- paste0(output_fp, 'full_results/')
dir.create(output_fp_full_results)
```

```{r}
#set up dataframe that contains only people who receive prison sentences & logged DV
df_short_prison_only <- df_short %>%
  filter(punishment_prison_days > 0) %>%
  mutate(punishment_prison_days_log = log(punishment_prison_days))
```

## Functions

```{r}
#function that computes raw differences in prison time for some specified characteristic
calculate_raw_difference <- function(df, characteristic){
 raw_diff_df_single_char <-  df %>%
      filter(!is.na(!!sym(characteristic))) %>% #keep only non NA obs
      #compute mean prison time and count cases
      group_by(!!sym(characteristic)) %>% 
      summarise(mean_sentence_length = mean(punishment_prison_days, na.rm = TRUE),
                count = n()) %>%
      pivot_wider(names_from = characteristic, values_from = c(mean_sentence_length, count)) %>%
      #compute prison time difference between groups
      mutate(Difference = mean_sentence_length_1 - mean_sentence_length_0,
             char = characteristic)
 return(raw_diff_df_single_char)
}

#function that carries out regression analysis and prepossesses regression results
#can easily be adapted for preferred standard errors
regression_analysis <- function(df, dv, ivs, output_fp_full_result){
  #set up formula
  fr <- paste0(dv, ' ~ ', ivs)
  
  #CHEKCK choose the model you want
  #vanilla OLS
  #fit <- lm(formula = fr, data = df)
  
  #SEs clustered on the judge ID level
  fit <- lm_robust(formula = as.formula(fr), data = df, clusters = judge__id)
  
  #Heteroskeadisticity robust SEs
  #fit <- coeftest(fit, vcov = vcovHC, type = 'HC0')
  
  #convert model object into df
  fit_df <- fit %>%
    #95% confidence intervals
    tidy(conf.int = T, conf.level = 0.95) %>%
    as.data.frame() %>%
    mutate(sig_level = case_when(p.value < 0.01 ~ '***',
                                   p.value < 0.05 ~ '**',
                                   p.value < 0.1 ~ '*',
                                   .default = 'insig'))
  
  #save full regression table
  write.csv(fit_df, output_fp_full_result)
  
  return(fit_df %>%
    dplyr::select(term, estimate, sig_level, conf.low, conf.high))
}
```

# Analysis

Each of the following section carries out analysis along a similar pattern: compute counts and raw differences in prison time and between some demographic groups, then run regressions of the form 'prison time \~ demographics + controls' with varying datasets, dependent variable definitions, and control sets. I fully commented the first section 'Defendant Characteristics' and included comments in other sections where I departed from the approach taken in Defendant Characteristics.

## Defendant Characteristics

```{r}
#set up results dataframe
defendant_char_df <- data.frame(char = defendant_chars_regression)

# binary variables for which I will compute raw differences
defendant_chars_binary <- c('defendant_is_woman', 'defendant_some_foreign_background',
                            'defendant_is_married', 'case_is_not_oslo')
#compute raw differences for the binary variables
raw_diff_df <- defendant_chars_binary %>%
  purrr::map_df(~ calculate_raw_difference(df_short_prison_only, .x))
#add raw difference to the results dataframe
defendant_char_df <- defendant_char_df %>%
  left_join(raw_diff_df, by = 'char')

#set up independent and control variables
ivs <- paste(c(defendant_chars_regression,  judge_chars_regression, sections_regression, circs_regression), collapse = ' + ')

# OLS: untransformed DV full dataset
fit_all_data_untransformed_dv_df <- regression_analysis(df = df_short, dv = 'punishment_prison_days', ivs = ivs, 
                                                        paste0(output_fp_full_results, 'defendant_char_all_data_untransformed_dv.csv')) %>%
  #rename variables to indicate model specifications
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  #select variables to keep
  dplyr::select(term, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

#merge regression results with results dataframe
defendant_char_df <- defendant_char_df %>%
  left_join(fit_all_data_untransformed_dv_df, by = c('char' = 'term'))

# untransformed DV prison sentences only
fit_prison_only_untransformed_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = ivs,
                                                           paste0(output_fp_full_results, 'defendant_char_prison_only_untransformed_dv.csv')) %>%
  #rename variables to indicate model specifications
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  #select variables to keep
  dplyr::select(term, regression_prison_only_days, regression_prison_only_days_sig_level, 
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

#merge regression results with results dataframe
defendant_char_df <- defendant_char_df %>%
  left_join(fit_prison_only_untransformed_dv_df, by = c('char' = 'term'))

#logged DV prison sentences only
fit_prison_only_logged_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days_log', ivs = ivs,
                                                    paste0(output_fp_full_results, 'defendant_char_prison_only_logged_dv.csv')) %>%
  #adapt beta coefficients so they can be interpreted in percentage terms
  mutate(estimate = case_when(term %in% c('defendant_is_woman', 'defendant_some_foreign_background',
                                          'defendant_is_married', 'case_is_not_oslo') ~ (exp(estimate)-1)*100,
                              term == 'defendant_log_net_income' ~ estimate,
                              .default = estimate * 100),
         ) %>%
  #rename variables to indicate model specifications
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
          regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  #select variables to keep
  dplyr::select(term, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

#merge regression results with results dataframe
defendant_char_df <- defendant_char_df %>%
  left_join(fit_prison_only_logged_dv_df, by = c('char' = 'term'))

#prison days only no controls
#compute separate models with no control for each defendant characteristic
fit_prison_only_untransformed_dv_df_no_contr <-  purrr::map_df(defendant_chars_regression, ~ regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = c(.x), paste0(output_fp_full_results, 'defendant_char_prison_only_untransformed_dv_', .x, '.csv')))  %>%
  #rename variables
  rename(regression_prison_only_days_no_contr = estimate,
         regression_prison_only_days_sig_level_no_contr = sig_level,
         regression_prison_only_days_conf_low_no_contr = conf.low,
         regression_prison_only_days_conf_high_no_contr = conf.high) %>%
  #select variables to keep
  dplyr::select(term, regression_prison_only_days_no_contr, regression_prison_only_days_sig_level_no_contr, 
                regression_prison_only_days_conf_low_no_contr, regression_prison_only_days_conf_high_no_contr)

#merge regression results with results dataframe
defendant_char_df <- defendant_char_df %>%
  left_join(fit_prison_only_untransformed_dv_df_no_contr, by = c('char' = 'term'))

# prison days only pers controls
fit_prison_only_untransformed_dv_df_pers <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = paste(defendant_chars_regression, collapse = ' + '), paste0(output_fp_full_results, 'defendant_char_prison_only_untransformed_dv_pers_controls.csv')) %>%
  #rename variables
  rename(regression_prison_only_days_pers = estimate,
         regression_prison_only_days_sig_level_pers = sig_level,
         regression_prison_only_days_conf_low_pers = conf.low,
         regression_prison_only_days_conf_high_pers = conf.high) %>%
  #select variables to keep
  dplyr::select(term, regression_prison_only_days_pers, regression_prison_only_days_sig_level_pers, 
                regression_prison_only_days_conf_low_pers, regression_prison_only_days_conf_high_pers)

#merge regression results with results dataframe
defendant_char_df <- defendant_char_df %>%
  left_join(fit_prison_only_untransformed_dv_df_pers, by = c('char' = 'term'))

#save results data frame
write.csv(defendant_char_df, paste0(output_fp, 'defendant_charactaristics.csv'))

#extract data from results dataframe for flourish and reformat
defendant_char_df_flourish <- defendant_char_df %>%
  filter(!(char %in% c('case_is_not_oslo', 'defendant_is_married'))) %>%
  dplyr::select(char, starts_with('regression_all_data_days')) %>%
  mutate(variable = case_when(char == 'defendant_age' ~ 'Age',
                              char == 'defendant_is_woman' ~ 'Gender: Female',
                              char == 'defendant_some_foreign_background' ~ 'Migration Background',
                              char == 'defendant_log_net_income' ~ 'Income (Log)',
                              .default = NA)) %>%
  pivot_longer(cols = c('regression_all_data_days', 'regression_all_data_days_conf_low', 'regression_all_data_days_conf_high'), names_to = 'Regression Result', values_to = 'Estimate')

#save flourish df
write.csv(defendant_char_df_flourish, paste0(output_fp, 'defendant_charactaristics_flourish.csv'))
```

## Judge Characteristics

```{r}
#set up results dataframe
judge_char_df <- data.frame(char = judge_chars_regression)

judge_chars_binary <- c('judge_is_woman', 'judge_some_foreign_background',
                            'judge_is_married')

#raw differences
raw_diff_df <- judge_chars_binary %>%
  purrr::map_df(~ calculate_raw_difference(df_short_prison_only, .x))

judge_char_df <- judge_char_df %>%
  left_join(raw_diff_df, by = 'char')

# OLS: untransformed DV full dataset
ivs <- paste(c(judge_chars_regression, defendant_chars_regression, sections_regression, circs_regression), collapse = ' + ')

fit_all_data_untransformed_dv_df <- regression_analysis(df = df_short, dv = 'punishment_prison_days', ivs = ivs,
                                                        paste0(output_fp_full_results, 'judge_char_all_data_untransformed_dv.csv')) %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  dplyr::select(term, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

judge_char_df <- judge_char_df %>%
  left_join(fit_all_data_untransformed_dv_df, by = c('char' = 'term'))

# untransformed DV prison sentences only
fit_prison_only_untransformed_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = ivs,
                                                           paste0(output_fp_full_results, 'judge_char_prison_only_untransformed_dv.csv')) %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  dplyr::select(term, regression_prison_only_days, regression_prison_only_days_sig_level, 
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

judge_char_df <- judge_char_df %>%
  left_join(fit_prison_only_untransformed_dv_df, by = c('char' = 'term'))

#logged DV prison sentences only
fit_prison_only_logged_dv_df <-  regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days_log', ivs = ivs,
                                                     paste0(output_fp_full_results, 'judge_char_prison_only_logged_dv.csv')) %>%
  mutate(estimate = case_when(term %in% c('judge_is_woman', 'judge_some_foreign_background',
                                          'judge_is_married', 'case_is_not_oslo') ~ (exp(estimate)-1)*100,
                              term == 'judge_log_net_income' ~ estimate,
                              .default = estimate * 100)) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level, 
         regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  dplyr::select(term, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

judge_char_df <- judge_char_df %>%
  left_join(fit_prison_only_logged_dv_df, by = c('char' = 'term'))

#prison days only no controls
fit_prison_only_untransformed_dv_df_no_contr <-  purrr::map_df(judge_chars_regression, ~ regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = c(.x), paste0(output_fp_full_results, 'judge_char_prison_only_untransformed_dv', .x, '.csv')))  %>%
  rename(regression_prison_only_days_no_contr = estimate,
         regression_prison_only_days_sig_level_no_contr = sig_level,
         regression_prison_only_days_conf_low_no_contr = conf.low,
         regression_prison_only_days_conf_high_no_contr = conf.high) %>%
  dplyr::select(term, regression_prison_only_days_no_contr, regression_prison_only_days_sig_level_no_contr, 
                regression_prison_only_days_conf_low_no_contr, regression_prison_only_days_conf_high_no_contr)

judge_char_df <- judge_char_df %>%
  left_join(fit_prison_only_untransformed_dv_df_no_contr, by = c('char' = 'term'))

# prison days only pers controls
fit_prison_only_untransformed_dv_df_pers <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = paste(judge_chars_regression, collapse = ' + '), paste0(output_fp_full_results, 'judge_char_prison_only_untransformed_dv_pers_controls.csv')) %>%
  rename(regression_prison_only_days_pers = estimate,
         regression_prison_only_days_sig_level_pers = sig_level,
         regression_prison_only_days_conf_low_pers = conf.low,
         regression_prison_only_days_conf_high_pers = conf.high) %>%
  dplyr::select(term, regression_prison_only_days_pers, regression_prison_only_days_sig_level_pers, 
                regression_prison_only_days_conf_low_pers, regression_prison_only_days_conf_high_pers)

judge_char_df <- judge_char_df %>%
  left_join(fit_prison_only_untransformed_dv_df_pers, by = c('char' = 'term'))


write.csv(judge_char_df, paste0(output_fp, 'judge_characteristics.csv'))

#flourish
judge_char_df_flourish <- judge_char_df %>%
  filter(!(char %in% c('judge_party', 'is_professional_judge', 'case_is_not_oslo', 'judge_is_married'))) %>%
  dplyr::select(char, starts_with('regression_all_data_days')) %>%
  mutate(variable = case_when(char == 'judge_age' ~ 'Age',
                              char == 'judge_is_woman' ~ 'Gender: Female',
                              char == 'judge_some_foreign_background' ~ 'Migration Background',
                              char == 'judge_log_net_income' ~ 'Income (Log)',
                              .default = NA)) %>%
  pivot_longer(cols = c('regression_all_data_days', 'regression_all_data_days_conf_low', 'regression_all_data_days_conf_high'), names_to = 'Regression Result', values_to = 'Estimate')

write.csv(judge_char_df_flourish, paste0(output_fp, 'judge_charactaristics_flourish.csv'))
```

## Gender x individual crimes

```{r}
#set up results dataframe
gender_crime_df <- data.frame(char = sections_regression)

#function to split dataset by specific crime
split_df_and_calculate_raw_difference <- function(df, characteristic, section){
  #only keep cases where defendant is convicted of 'section'
  split_df <- df %>%
    filter(!!sym(section) == 1)
  
  #calculate raw difference by characteristic
  diff_df <- calculate_raw_difference(split_df, characteristic) %>%
    mutate(char = section)
  
  return(diff_df)
}

#calculate difference in prison time by gender and section
raw_diff_df <- sections_regression %>%
  purrr::map_df(~ split_df_and_calculate_raw_difference(df_short, 'defendant_is_woman', .x))

gender_crime_df <- gender_crime_df %>%
  left_join(raw_diff_df, by = 'char')

#set up independent and control variables: include interaction terms of gender and each of the sections
interaction_terms <- paste(sections_regression, 'defendant_is_woman', sep = ' * ')
ivs <- paste0(paste(c(defendant_chars_regression[defendant_chars_regression != 'defendant_is_woman'], judge_chars_regression, interaction_terms, circs_regression), collapse = ' + '))

# OLS: untransformed DV full dataset
fit_all_data_untransformed_dv_df <- regression_analysis(df = df_short, dv = 'punishment_prison_days', ivs = ivs, 
                                                        paste0(output_fp_full_results, 'gender_crime_all_data_untransformed_dv.csv')) %>%
      mutate(section = case_when(str_detect(term, pattern = ':') ~ str_remove(term, 'defendant_is_woman:'),
                                 .default = NA)) %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  select(section, regression_all_data_days, regression_all_data_days_sig_level,
         regression_all_data_days_conf_low, regression_all_data_days_conf_high)

gender_crime_df <- gender_crime_df %>%
  left_join(fit_all_data_untransformed_dv_df, by = c('char' = 'section'))

# untransformed DV prison sentences only
fit_prison_only_untransformed_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = ivs,
                                                           paste0(output_fp_full_results, 'gender_crime_prison_only_untransformed_dv.csv')) %>%
  mutate(section = case_when(str_detect(term, pattern = ':') ~ str_remove(term, 'defendant_is_woman:'),
                                 .default = NA)) %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  select(section, regression_prison_only_days, regression_prison_only_days_sig_level,
         regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

gender_crime_df <- gender_crime_df %>%
  left_join(fit_prison_only_untransformed_dv_df, by = c('char' = 'section'))


#logged DV prison sentences only
fit_prison_only_logged_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days_log', ivs = ivs,
                                                    paste0(output_fp_full_results, 'gender_crime_prison_only_logged_dv.csv')) %>%
  mutate(estimate = (exp(estimate)-1)*100,
             section = case_when(str_detect(term, pattern = ':') ~ str_remove(term, 'defendant_is_woman:'),
                                 .default = NA)) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
         regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  select(section, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
         regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

gender_crime_df <- gender_crime_df %>%
  left_join(fit_prison_only_logged_dv_df, by = c('char' = 'section'))

write.csv(gender_crime_df, paste0(output_fp, 'gender_crime.csv'))
```

## Gender x migration background

This section follows a similar approach to previous sections except that we duplicated each model: once for men and once for women

```{r}
#set up separate dataframes by gender
df_short_male <- df_short %>%
  filter(defendant_is_woman == '0')

df_short_female <- df_short %>%
  filter(defendant_is_woman == '1')

df_short_prison_only_male <- df_short_prison_only %>%
  filter(defendant_is_woman == '0')

df_short_prison_only_female <- df_short_prison_only %>%
  filter(defendant_is_woman == '1')

#compute raw differences
gender_foreign_df <- df_short %>%
  filter(!is.na(defendant_gender), !is.na(defendant_some_foreign_background)) %>%
  group_by(defendant_gender, defendant_some_foreign_background) %>%
  summarise(mean_outcome = mean(punishment_prison_days, na.rm = T)) %>% 
  mutate(defendant_gender_EN = ifelse(defendant_gender == 'M', 'male', 'female')) %>%
  pivot_wider(names_from = 'defendant_some_foreign_background', names_prefix = 'group_',
              values_from = mean_outcome) %>%
  mutate(Difference = group_1 - group_0)


# OLS: untransformed DV full dataset
ivs <- paste(c(defendant_chars_regression[defendant_chars_regression != 'defendant_is_woman'], judge_chars_regression, sections_regression, circs_regression), collapse = ' + ')

#male
fit_all_data_untransformed_dv_df_male <- regression_analysis(df = df_short_male, dv = 'punishment_prison_days', ivs = ivs,
                                                             paste0(output_fp_full_results, 'male_all_data_untransformed_dv.csv')) %>%
  mutate(defendant_gender_EN = 'male') %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  filter(term == 'defendant_some_foreign_background') %>%
  dplyr::select(defendant_gender_EN, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

#female
fit_all_data_untransformed_dv_df_female <- regression_analysis(df = df_short_female, dv = 'punishment_prison_days', ivs = ivs,
                                                               paste0(output_fp_full_results, 'female_all_data_untransformed_dv.csv')) %>%
  mutate(defendant_gender_EN = 'female') %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  filter(term == 'defendant_some_foreign_background') %>%
  dplyr::select(defendant_gender_EN, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

#combined
fit_all_data_untransformed_dv_df_combined <- fit_all_data_untransformed_dv_df_male %>%
  bind_rows(fit_all_data_untransformed_dv_df_female)

gender_foreign_df <- gender_foreign_df %>%
  left_join(fit_all_data_untransformed_dv_df_combined, by = c('defendant_gender_EN'))


# OLS: untransformed DV prison only

#male
fit_prison_only_untransformed_dv_df_male <- regression_analysis(df = df_short_prison_only_male, dv = 'punishment_prison_days', ivs = ivs,
                                                                paste0(output_fp_full_results, 'male_prison_only_untransformed_dv.csv')) %>%
  mutate(defendant_gender_EN = 'male') %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  filter(term == 'defendant_some_foreign_background') %>%
  dplyr::select(defendant_gender_EN, regression_prison_only_days, regression_prison_only_days_sig_level, 
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

#female
fit_prison_only_untransformed_dv_df_female <- regression_analysis(df = df_short_prison_only_female, dv = 'punishment_prison_days', ivs = ivs,
                                                                  paste0(output_fp_full_results, 'female_prison_only_untransformed_dv.csv')) %>%
  mutate(defendant_gender_EN = 'female') %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  filter(term == 'defendant_some_foreign_background') %>%
  dplyr::select(defendant_gender_EN, regression_prison_only_days, regression_prison_only_days_sig_level,
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

#combined
fit_prison_only_untransformed_dv_df_combined <- fit_prison_only_untransformed_dv_df_male %>%
  bind_rows(fit_prison_only_untransformed_dv_df_female)

gender_foreign_df <- gender_foreign_df %>%
  left_join(fit_prison_only_untransformed_dv_df_combined, by = c('defendant_gender_EN'))

# OLS: logged DV prison only

#male
fit_prison_only_logged_dv_df_male <- regression_analysis(df = df_short_prison_only_male, dv = 'punishment_prison_days_log', ivs = ivs,
                                                         paste0(output_fp_full_results, 'male_prison_only_logged_dv.csv')) %>%
  mutate(defendant_gender_EN = 'male',
         estimate = (exp(estimate)-1)*100) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
         regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  filter(term == 'defendant_some_foreign_background') %>%
  dplyr::select(defendant_gender_EN, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

#female
fit_prison_only_logged_dv_df_female <- regression_analysis(df = df_short_prison_only_female, dv = 'punishment_prison_days_log', ivs = ivs,
                                                           paste0(output_fp_full_results, 'female_prison_only_logged_dv.csv')) %>%
  mutate(defendant_gender_EN = 'female',
         estimate = (exp(estimate)-1)*100) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
         regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  filter(term == 'defendant_some_foreign_background') %>%
  dplyr::select(defendant_gender_EN, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_low)

#combined
fit_prison_only_logged_dv_df_combined <- fit_prison_only_logged_dv_df_male %>%
  bind_rows(fit_prison_only_logged_dv_df_female)

gender_foreign_df <- gender_foreign_df %>%
  left_join(fit_prison_only_logged_dv_df_combined, by = c('defendant_gender_EN'))

write.csv(gender_foreign_df, paste0(output_fp, 'gender_foreign_background.csv'))
```

## Migration Background x Judge Age

Here we triplicated the analysis: once for a dataset restricted to foreign background defendants, once for native defendants, and once for the entire dataset focused on defendant x judge age interactions

```{r}
df_short <- df_short %>%
  mutate(judge_age_groups = factor(judge_age_groups, levels = c("< 30", "30 - 55", "> 55")))

#set up separate dataframes for native and foreign background defendants
df_short_native <- df_short %>%
  filter(defendant_some_foreign_background == '0')

df_short_immigrant <- df_short %>%
  filter(defendant_some_foreign_background == '1')

df_short_prison_only_native <- df_short_prison_only %>%
  filter(defendant_some_foreign_background == '0')

df_short_prison_only_immigrant <- df_short_prison_only %>%
  filter(defendant_some_foreign_background == '1')

#results data frame
judge_age_foreign_df <- data.frame(migration_background =  c('native', 'immigrant', 'interaction'))

#compute raw differences
raw_diff_df <- df_short %>%
  filter(!is.na(judge_age_groups), !is.na(defendant_some_foreign_background)) %>%
  group_by(judge_age_groups, defendant_some_foreign_background) %>%
  summarise(mean_outcome = mean(punishment_prison_days, na.rm = T)) %>% 
  mutate(migration_background = ifelse(defendant_some_foreign_background == '0', 'native', 'immigrant')) %>%
  pivot_wider(names_from = 'judge_age_groups', names_prefix = 'group_',
              values_from = mean_outcome)

judge_age_foreign_df <- judge_age_foreign_df %>%
  left_join(raw_diff_df, by = 'migration_background')

#set up independent and control variables
#ivs for the native/immmigrant analyses include the usual set except 'defendant_foreign_background' since there is no variance left in that variable
ivs <- paste(c(judge_chars_regression, defendant_chars_regression[defendant_chars_regression != 'defendant_some_foreign_background'], sections_regression, circs_regression), collapse = ' + ')
#ivs_interaction additionally includes an interaction term between defendant foreign background and judge age
ivs_interaction <- paste(c('judge_age * defendant_some_foreign_background', judge_chars_regression[judge_chars_regression != 'judge_age'], defendant_chars_regression[defendant_chars_regression != 'defendant_some_foreign_background'], sections_regression, circs_regression), collapse = ' + ')


# OLS: untransformed DV full dataset

#native
fit_all_data_untransformed_dv_df_native <- regression_analysis(df = df_short_native, dv = 'punishment_prison_days', ivs = ivs,
                                                               paste0(output_fp_full_results, 'native_all_data_untransformed_dv.csv')) %>%
  mutate(migration_background = 'native') %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  filter(term == 'judge_age') %>%
  dplyr::select(migration_background, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

#immigrant
fit_all_data_untransformed_dv_df_immigrant <- regression_analysis(df = df_short_immigrant, dv = 'punishment_prison_days', ivs = ivs,
                                                                  paste0(output_fp_full_results, 'immigrant_all_data_untransformed_dv.csv')) %>%
  mutate(migration_background = 'immigrant') %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  filter(term == 'judge_age') %>%
  dplyr::select(migration_background, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

#interaction
fit_all_data_untransformed_dv_df_interaction <- regression_analysis(df = df_short, dv = 'punishment_prison_days', ivs = ivs_interaction,
                                                                    paste0(output_fp_full_results, 'judge_age_immigrant_interact_all_data_untransformed_dv.csv')) %>%
  mutate(migration_background = 'interaction') %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  filter(grepl(':', term)) %>%
  dplyr::select(migration_background, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

#combined
fit_all_data_untransformed_dv_df_combined <- fit_all_data_untransformed_dv_df_native %>%
  bind_rows(fit_all_data_untransformed_dv_df_immigrant) %>%
  bind_rows(fit_all_data_untransformed_dv_df_interaction)

judge_age_foreign_df <- judge_age_foreign_df %>%
  left_join(fit_all_data_untransformed_dv_df_combined, by = c('migration_background'))


# OLS: untransformed DV prison only

#native
fit_prison_only_untransformed_dv_df_native <- regression_analysis(df = df_short_prison_only_native, dv = 'punishment_prison_days', ivs = ivs,
                                                                  paste0(output_fp_full_results, 'native_prison_only_untransformed_dv.csv')) %>%
  mutate(migration_background = 'native') %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  filter(term == 'judge_age') %>%
  dplyr::select(migration_background, regression_prison_only_days, regression_prison_only_days_sig_level,
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

#immigrant
fit_prison_only_untransformed_dv_df_immigrant <- regression_analysis(df = df_short_prison_only_immigrant, dv = 'punishment_prison_days', ivs = ivs,
                                                                     paste0(output_fp_full_results, 'immigrant_prison_only_untransformed_dv.csv')) %>%
  mutate(migration_background = 'immigrant') %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  filter(term == 'judge_age') %>%
  dplyr::select(migration_background, regression_prison_only_days, regression_prison_only_days_sig_level,
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

#interaction
fit_prison_only_untransformed_dv_df_interaction <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = ivs_interaction,
                                                                       paste0(output_fp_full_results, 'judge_age_immigrant_interact_prison_only_untransformed_dv.csv')) %>%
  mutate(migration_background = 'interaction') %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  filter(grepl(':', term)) %>%
  dplyr::select(migration_background, regression_prison_only_days, regression_prison_only_days_sig_level,
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

#combined
fit_prison_only_untransformed_dv_df_combined <- fit_prison_only_untransformed_dv_df_native %>%
  bind_rows(fit_prison_only_untransformed_dv_df_immigrant) %>%
  bind_rows(fit_prison_only_untransformed_dv_df_interaction)

judge_age_foreign_df <- judge_age_foreign_df %>%
  left_join(fit_prison_only_untransformed_dv_df_combined, by = c('migration_background'))

# OLS: logged DV prison only

#native
fit_prison_only_logged_dv_df_native <- regression_analysis(df = df_short_prison_only_native, dv = 'punishment_prison_days_log', ivs = ivs,
                                                           paste0(output_fp_full_results, 'native_prison_only_logged_dv.csv')) %>%
  mutate(migration_background = 'native',
         estimate = 100*estimate) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
         regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  filter(term == 'judge_age') %>%
  dplyr::select(migration_background, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

#immigrant
fit_prison_only_logged_dv_df_immigrant <- regression_analysis(df = df_short_prison_only_immigrant, dv = 'punishment_prison_days_log', ivs = ivs,
                                                              paste0(output_fp_full_results, 'immigrant_prison_only_logged_dv.csv')) %>%
  mutate(migration_background = 'immigrant',
         estimate = 100*estimate) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
         regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  filter(term == 'judge_age') %>%
  dplyr::select(migration_background, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

#interaction
fit_prison_only_logged_dv_df_interaction <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days_log', ivs = ivs_interaction,
                                                                 paste0(output_fp_full_results, 'judge_age_immigrant_interact_prison_only_logged_dv.csv')) %>%
  mutate(migration_background = 'interaction',
         estimate = 100*estimate) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
         regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  filter(grepl(':', term)) %>%
  dplyr::select(migration_background, regression_prison_only_percentage, regression_prison_only_percentage_sig_level)

#combined
fit_prison_only_logged_dv_df_combined <- fit_prison_only_logged_dv_df_native %>%
  bind_rows(fit_prison_only_logged_dv_df_immigrant) %>%
  bind_rows(fit_prison_only_logged_dv_df_interaction)

judge_age_foreign_df <- judge_age_foreign_df %>%
  left_join(fit_prison_only_logged_dv_df_combined, by = c('migration_background'))

write.csv(judge_age_foreign_df, paste0(output_fp, 'judge_age_migration_background.csv'))


#Plot some of the effects for use in the methodology
fit_interact <- lm_robust(formula = as.formula(paste0('punishment_prison_days ~ ', ivs_interaction)), data = df_short_prison_only, clusters = judge__id)

plot_model(fit_interact, 'int')+
  labs(title = 'Interaction Effect of Judge Age \nand Defendant Foreign Background', 
       color = 'Foreign Background',
       y = 'Prison Days',
       x = 'Judge Age')+
  xlim(20,80)+
  ylim(0,300)+
  theme_bw()
ggsave(paste(output_fp, 'judge_age_migration_background_interact.png'), width = 8, height = 6)

fit_migrants <- lm_robust(formula = as.formula(paste0('punishment_prison_days ~ ', ivs)), data = df_short_prison_only_immigrant, clusters = judge__id)
plot1 <- plot_model(fit_migrants, type = 'pred', terms = 'judge_age', colors = '#ce4631')+
   labs(title = 'Foreign background', 
       color = 'Foreign Background',
       y = NULL,
       x = 'Judge Age')+
  xlim(20,80)+
  ylim(0,300)+
  theme(
    text = element_text(family = "Barlow", size = 14), # Change font and size globally
    plot.title = element_text(face = "bold", size = 13),        # Bold and larger font for title
    axis.title = element_text(size = 13),                      # Axis titles font size
    axis.text = element_text(size = 12),    
    panel.background = element_rect(fill = rgb(250, 240, 240, maxColorValue = 255), color = NA), # Panel background
    plot.background = element_rect(fill = rgb(250, 240, 240, maxColorValue = 255), color = NA),  # Entire plot background
    panel.border = element_rect(color = "black", fill = NA)# Axis labels font size
  )
ggsave(paste(output_fp, 'judge_age_migration_background_fb_only.png'), width = 8, height = 6)


fit_natives <- lm_robust(formula = as.formula(paste0('punishment_prison_days ~ ', ivs)), data = df_short_prison_only_native, clusters = judge__id)
plot2 <- plot_model(fit_natives, type = 'pred', terms = 'judge_age', colors = '#374e8e')+
   labs(title = 'Native background', 
       color = 'Foreign Background',
       y = 'Prison sentence (days)',
       x = 'Judge Age')+
  xlim(20,80)+
  ylim(0,300)+
  theme(
    text = element_text(family = "Barlow", size = 14), # Change font and size globally
    plot.title = element_text(face = "bold", size = 13),        # Bold and larger font for title
    axis.title = element_text(size = 13),                      # Axis titles font size
    axis.text = element_text(size = 12),    
    panel.background = element_rect(fill = rgb(250, 240, 240, maxColorValue = 255), color = NA), # Panel background
    plot.background = element_rect(fill = rgb(250, 240, 240, maxColorValue = 255), color = NA),  # Entire plot background
    panel.border = element_rect(color = "black", fill = NA)# Axis labels font size
  )
ggsave(paste(output_fp, 'judge_age_migration_background_natives_only.png'), width = 8, height = 6)

# Combine the plots side by side
combined_plot <- plot2 + plot1 + plot_layout(ncol = 2, widths = c(1, 1)) + plot_annotation(
    title = "Older judges hand out harsher sentences to defendants with a foreign background",
    subtitle = "Effect of judge age on prison sentences for defendants with a foreign and native background.",
    theme = theme(
      text = element_text(family = "Barlow", size = 14),
      plot.title = element_text(face = "bold", size = 16, hjust = 0), 
      plot.subtitle = element_text(size = 12, hjust = 0),
      plot.margin = margin(10, 10, 10, 10),
      panel.background = element_rect(fill = rgb(250, 240, 240, maxColorValue = 255), color = NA), # Panel background
      plot.background = element_rect(fill = rgb(250, 240, 240, maxColorValue = 255), color = NA),
    )
  )

# Display the combined plot
combined_plot

ggsave(
  paste(output_fp, 'combined_plot_age_migration_background.png'), # File name with .svg extension
  plot = combined_plot,          # The plot object to save
  width = 10,                    # Width in inches
  height = 6,                    # Height in inches
  dpi = 300                      # Resolution (not as relevant for vector formats like SVG)
)

```

## Judge Age Defendant Income

```{r}
judge_age_defendant_income_df <- data.frame(term = c('judge_age', 'defendant_log_net_income', 'judge_age:defendant_log_net_income'))

#IVs include the usual controls and an interaction term for judge age and defendant income
ivs <- paste0('judge_age*defendant_log_net_income + ', paste(c(defendant_chars_regression,  judge_chars_regression, sections_regression, circs_regression), collapse = ' + '))

# OLS: untransformed DV full dataset
fit_all_data_untransformed_dv_df <- regression_analysis(df = df_short, dv = 'punishment_prison_days', ivs = ivs,
                                                         paste0(output_fp_full_results, 'judge_age_defendant_income_all_data_untransformed_dv.csv')) %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  dplyr::select(term, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

judge_age_defendant_income_df <- judge_age_defendant_income_df %>%
  left_join(fit_all_data_untransformed_dv_df, by ='term')

# untransformed DV prison sentences only
fit_prison_only_untransformed_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = ivs,
                                                           paste0(output_fp_full_results, 'judge_age_defendant_income_prison_only_untransformed_dv.csv')) %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  dplyr::select(term, regression_prison_only_days, regression_prison_only_days_sig_level, 
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

judge_age_defendant_income_df <- judge_age_defendant_income_df %>%
  left_join(fit_prison_only_untransformed_dv_df, by = 'term')

#logged DV prison sentences only
fit_prison_only_logged_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days_log', ivs = ivs,
                                                    paste0(output_fp_full_results, 'judge_age_defendant_income_prison_only_logged_dv.csv')) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
          regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  dplyr::select(term, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

judge_age_defendant_income_df <- judge_age_defendant_income_df %>%
  left_join(fit_prison_only_logged_dv_df, by = 'term')

write.csv(judge_age_defendant_income_df, paste0(output_fp, 'judge_age_defendant_income.csv'))
```

## Judge Income Defendant Income

```{r}
judge_income_defendant_income_df <- data.frame(term = c('judge_log_net_income', 'defendant_log_net_income', 'judge_log_net_income:defendant_log_net_income'))

#ivs include the usual controls and an interaction term for judge and defendant incomes
ivs <- paste0('judge_log_net_income*defendant_log_net_income + ', paste(c(defendant_chars_regression,  judge_chars_regression, sections_regression, circs_regression), collapse = ' + '))

# OLS: untransformed DV full dataset
fit_all_data_untransformed_dv_df <- regression_analysis(df = df_short, dv = 'punishment_prison_days', ivs = ivs,
                                                        paste0(output_fp_full_results, 'judge_income_defendant_income_all_data_untransformed_dv.csv')) %>%
  rename(regression_all_data_days = estimate,
         regression_all_data_days_sig_level = sig_level,
         regression_all_data_days_conf_low = conf.low,
         regression_all_data_days_conf_high = conf.high) %>%
  dplyr::select(term, regression_all_data_days, regression_all_data_days_sig_level,
                regression_all_data_days_conf_low, regression_all_data_days_conf_high)

judge_income_defendant_income_df <- judge_income_defendant_income_df %>%
  left_join(fit_all_data_untransformed_dv_df, by ='term')

# untransformed DV prison sentences only
fit_prison_only_untransformed_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days', ivs = ivs,
                                                           paste0(output_fp_full_results, 'judge_income_defendant_income_prison_only_untransformed_dv.csv')) %>%
  rename(regression_prison_only_days = estimate,
         regression_prison_only_days_sig_level = sig_level,
         regression_prison_only_days_conf_low = conf.low,
         regression_prison_only_days_conf_high = conf.high) %>%
  dplyr::select(term, regression_prison_only_days, regression_prison_only_days_sig_level, 
                regression_prison_only_days_conf_low, regression_prison_only_days_conf_high)

judge_income_defendant_income_df <- judge_income_defendant_income_df %>%
  left_join(fit_prison_only_untransformed_dv_df, by = 'term')

#logged DV prison sentences only
fit_prison_only_logged_dv_df <- regression_analysis(df = df_short_prison_only, dv = 'punishment_prison_days_log', ivs = ivs,
                                                    paste0(output_fp_full_results, 'judge_income_defendant_income_prison_only_logged_dv.csv')) %>%
  rename(regression_prison_only_percentage = estimate,
         regression_prison_only_percentage_sig_level = sig_level,
          regression_prison_only_percentage_conf_low = conf.low,
         regression_prison_only_percentage_conf_high = conf.high) %>%
  dplyr::select(term, regression_prison_only_percentage, regression_prison_only_percentage_sig_level,
                regression_prison_only_percentage_conf_low, regression_prison_only_percentage_conf_high)

judge_income_defendant_income_df <- judge_income_defendant_income_df %>%
  left_join(fit_prison_only_logged_dv_df, by = 'term')

write.csv(judge_income_defendant_income_df, paste0(output_fp, 'judge_income_defendant_income.csv'))
```
